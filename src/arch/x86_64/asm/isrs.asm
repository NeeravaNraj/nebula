[bits 64]

extern isr_handler

%macro ISR_WITH_ERROR 1
global isr_%1
isr_%1:
    push %1
    jmp isr_common
%endmacro

%macro ISR_WITHOUT_ERROR 1
global isr_%1
isr_%1:
    push 0
    push %1
    jmp isr_common
%endmacro

%macro pushaq 0
    push rax
    push rcx
    push rdx
    push rbx
    push rbp
    push rsi
    push rdi
    push r8
    push r9
    push r10
    push r11
    push r12
    push r13
    push r14
    push r15
%endmacro

%macro popaq 0
    pop r15
    pop r14
    pop r13
    pop r12
    pop r11
    pop r10
    pop r9
    pop r8
    pop rdi
    pop rsi
    pop rbp
    pop rbx
    pop rdx
    pop rcx
    pop rax
%endmacro

ISR_WITH_ERROR 8
ISR_WITH_ERROR 10
ISR_WITH_ERROR 11
ISR_WITH_ERROR 12
ISR_WITH_ERROR 13
ISR_WITH_ERROR 14
ISR_WITH_ERROR 17
ISR_WITH_ERROR 21

ISR_WITHOUT_ERROR 0
ISR_WITHOUT_ERROR 1
ISR_WITHOUT_ERROR 2
ISR_WITHOUT_ERROR 3
ISR_WITHOUT_ERROR 4
ISR_WITHOUT_ERROR 5
ISR_WITHOUT_ERROR 6
ISR_WITHOUT_ERROR 7
ISR_WITHOUT_ERROR 9

ISR_WITHOUT_ERROR 16
ISR_WITHOUT_ERROR 18
ISR_WITHOUT_ERROR 19
ISR_WITHOUT_ERROR 20
; reserved
ISR_WITHOUT_ERROR 32
ISR_WITHOUT_ERROR 33
ISR_WITHOUT_ERROR 34
ISR_WITHOUT_ERROR 35
ISR_WITHOUT_ERROR 36
ISR_WITHOUT_ERROR 37
ISR_WITHOUT_ERROR 38
ISR_WITHOUT_ERROR 39
ISR_WITHOUT_ERROR 40
ISR_WITHOUT_ERROR 41
ISR_WITHOUT_ERROR 42
ISR_WITHOUT_ERROR 43
ISR_WITHOUT_ERROR 44
ISR_WITHOUT_ERROR 45
ISR_WITHOUT_ERROR 46
ISR_WITHOUT_ERROR 47
ISR_WITHOUT_ERROR 48
ISR_WITHOUT_ERROR 49
ISR_WITHOUT_ERROR 50
ISR_WITHOUT_ERROR 51
ISR_WITHOUT_ERROR 52
ISR_WITHOUT_ERROR 53
ISR_WITHOUT_ERROR 54
ISR_WITHOUT_ERROR 55
ISR_WITHOUT_ERROR 56
ISR_WITHOUT_ERROR 57
ISR_WITHOUT_ERROR 58
ISR_WITHOUT_ERROR 59
ISR_WITHOUT_ERROR 60
ISR_WITHOUT_ERROR 61
ISR_WITHOUT_ERROR 62
ISR_WITHOUT_ERROR 63
ISR_WITHOUT_ERROR 64
ISR_WITHOUT_ERROR 65
ISR_WITHOUT_ERROR 66
ISR_WITHOUT_ERROR 67
ISR_WITHOUT_ERROR 68
ISR_WITHOUT_ERROR 69
ISR_WITHOUT_ERROR 70
ISR_WITHOUT_ERROR 71
ISR_WITHOUT_ERROR 72
ISR_WITHOUT_ERROR 73
ISR_WITHOUT_ERROR 74
ISR_WITHOUT_ERROR 75
ISR_WITHOUT_ERROR 76
ISR_WITHOUT_ERROR 77
ISR_WITHOUT_ERROR 78
ISR_WITHOUT_ERROR 79
ISR_WITHOUT_ERROR 80
ISR_WITHOUT_ERROR 81
ISR_WITHOUT_ERROR 82
ISR_WITHOUT_ERROR 83
ISR_WITHOUT_ERROR 84
ISR_WITHOUT_ERROR 85
ISR_WITHOUT_ERROR 86
ISR_WITHOUT_ERROR 87
ISR_WITHOUT_ERROR 88
ISR_WITHOUT_ERROR 89
ISR_WITHOUT_ERROR 90
ISR_WITHOUT_ERROR 91
ISR_WITHOUT_ERROR 92
ISR_WITHOUT_ERROR 93
ISR_WITHOUT_ERROR 94
ISR_WITHOUT_ERROR 95
ISR_WITHOUT_ERROR 96
ISR_WITHOUT_ERROR 97
ISR_WITHOUT_ERROR 98
ISR_WITHOUT_ERROR 99
ISR_WITHOUT_ERROR 100
ISR_WITHOUT_ERROR 101
ISR_WITHOUT_ERROR 102
ISR_WITHOUT_ERROR 103
ISR_WITHOUT_ERROR 104
ISR_WITHOUT_ERROR 105
ISR_WITHOUT_ERROR 106
ISR_WITHOUT_ERROR 107
ISR_WITHOUT_ERROR 108
ISR_WITHOUT_ERROR 109
ISR_WITHOUT_ERROR 110
ISR_WITHOUT_ERROR 111
ISR_WITHOUT_ERROR 112
ISR_WITHOUT_ERROR 113
ISR_WITHOUT_ERROR 114
ISR_WITHOUT_ERROR 115
ISR_WITHOUT_ERROR 116
ISR_WITHOUT_ERROR 117
ISR_WITHOUT_ERROR 118
ISR_WITHOUT_ERROR 119
ISR_WITHOUT_ERROR 120
ISR_WITHOUT_ERROR 121
ISR_WITHOUT_ERROR 122
ISR_WITHOUT_ERROR 123
ISR_WITHOUT_ERROR 124
ISR_WITHOUT_ERROR 125
ISR_WITHOUT_ERROR 126
ISR_WITHOUT_ERROR 127
ISR_WITHOUT_ERROR 128
ISR_WITHOUT_ERROR 129
ISR_WITHOUT_ERROR 130
ISR_WITHOUT_ERROR 131
ISR_WITHOUT_ERROR 132
ISR_WITHOUT_ERROR 133
ISR_WITHOUT_ERROR 134
ISR_WITHOUT_ERROR 135
ISR_WITHOUT_ERROR 136
ISR_WITHOUT_ERROR 137
ISR_WITHOUT_ERROR 138
ISR_WITHOUT_ERROR 139
ISR_WITHOUT_ERROR 140
ISR_WITHOUT_ERROR 141
ISR_WITHOUT_ERROR 142
ISR_WITHOUT_ERROR 143
ISR_WITHOUT_ERROR 144
ISR_WITHOUT_ERROR 145
ISR_WITHOUT_ERROR 146
ISR_WITHOUT_ERROR 147
ISR_WITHOUT_ERROR 148
ISR_WITHOUT_ERROR 149
ISR_WITHOUT_ERROR 150
ISR_WITHOUT_ERROR 151
ISR_WITHOUT_ERROR 152
ISR_WITHOUT_ERROR 153
ISR_WITHOUT_ERROR 154
ISR_WITHOUT_ERROR 155
ISR_WITHOUT_ERROR 156
ISR_WITHOUT_ERROR 157
ISR_WITHOUT_ERROR 158
ISR_WITHOUT_ERROR 159
ISR_WITHOUT_ERROR 160
ISR_WITHOUT_ERROR 161
ISR_WITHOUT_ERROR 162
ISR_WITHOUT_ERROR 163
ISR_WITHOUT_ERROR 164
ISR_WITHOUT_ERROR 165
ISR_WITHOUT_ERROR 166
ISR_WITHOUT_ERROR 167
ISR_WITHOUT_ERROR 168
ISR_WITHOUT_ERROR 169
ISR_WITHOUT_ERROR 170
ISR_WITHOUT_ERROR 171
ISR_WITHOUT_ERROR 172
ISR_WITHOUT_ERROR 173
ISR_WITHOUT_ERROR 174
ISR_WITHOUT_ERROR 175
ISR_WITHOUT_ERROR 176
ISR_WITHOUT_ERROR 177
ISR_WITHOUT_ERROR 178
ISR_WITHOUT_ERROR 179
ISR_WITHOUT_ERROR 180
ISR_WITHOUT_ERROR 181
ISR_WITHOUT_ERROR 182
ISR_WITHOUT_ERROR 183
ISR_WITHOUT_ERROR 184
ISR_WITHOUT_ERROR 185
ISR_WITHOUT_ERROR 186
ISR_WITHOUT_ERROR 187
ISR_WITHOUT_ERROR 188
ISR_WITHOUT_ERROR 189
ISR_WITHOUT_ERROR 190
ISR_WITHOUT_ERROR 191
ISR_WITHOUT_ERROR 192
ISR_WITHOUT_ERROR 193
ISR_WITHOUT_ERROR 194
ISR_WITHOUT_ERROR 195
ISR_WITHOUT_ERROR 196
ISR_WITHOUT_ERROR 197
ISR_WITHOUT_ERROR 198
ISR_WITHOUT_ERROR 199
ISR_WITHOUT_ERROR 200
ISR_WITHOUT_ERROR 201
ISR_WITHOUT_ERROR 202
ISR_WITHOUT_ERROR 203
ISR_WITHOUT_ERROR 204
ISR_WITHOUT_ERROR 205
ISR_WITHOUT_ERROR 206
ISR_WITHOUT_ERROR 207
ISR_WITHOUT_ERROR 208
ISR_WITHOUT_ERROR 209
ISR_WITHOUT_ERROR 210
ISR_WITHOUT_ERROR 211
ISR_WITHOUT_ERROR 212
ISR_WITHOUT_ERROR 213
ISR_WITHOUT_ERROR 214
ISR_WITHOUT_ERROR 215
ISR_WITHOUT_ERROR 216
ISR_WITHOUT_ERROR 217
ISR_WITHOUT_ERROR 218
ISR_WITHOUT_ERROR 219
ISR_WITHOUT_ERROR 220
ISR_WITHOUT_ERROR 221
ISR_WITHOUT_ERROR 222
ISR_WITHOUT_ERROR 223
ISR_WITHOUT_ERROR 224
ISR_WITHOUT_ERROR 225
ISR_WITHOUT_ERROR 226
ISR_WITHOUT_ERROR 227
ISR_WITHOUT_ERROR 228
ISR_WITHOUT_ERROR 229
ISR_WITHOUT_ERROR 230
ISR_WITHOUT_ERROR 231
ISR_WITHOUT_ERROR 232
ISR_WITHOUT_ERROR 233
ISR_WITHOUT_ERROR 234
ISR_WITHOUT_ERROR 235
ISR_WITHOUT_ERROR 236
ISR_WITHOUT_ERROR 237
ISR_WITHOUT_ERROR 238
ISR_WITHOUT_ERROR 239
ISR_WITHOUT_ERROR 240
ISR_WITHOUT_ERROR 241
ISR_WITHOUT_ERROR 242
ISR_WITHOUT_ERROR 243
ISR_WITHOUT_ERROR 244
ISR_WITHOUT_ERROR 245
ISR_WITHOUT_ERROR 246
ISR_WITHOUT_ERROR 247
ISR_WITHOUT_ERROR 248
ISR_WITHOUT_ERROR 249
ISR_WITHOUT_ERROR 250
ISR_WITHOUT_ERROR 251
ISR_WITHOUT_ERROR 252
ISR_WITHOUT_ERROR 253
ISR_WITHOUT_ERROR 254
ISR_WITHOUT_ERROR 255

isr_common:
    pushaq

    mov rax, cr2
    push rax

    mov rax, cr3
    push rax

    mov rdi, rsp ; save stack pointer to pass as arg

    push QWORD [rdi+152]
    push rbp
    mov rbp, rsp ; Setup clean stack frame

    call isr_handler

    add rsp, 16  ; ignores the previous 2 pushed items

    pop rax
    mov cr3, rax

    pop rax
    mov cr2, rax

    popaq
    add rsp, 16

    iretq
